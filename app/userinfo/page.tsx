'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { checkLoginStatus, getCurrentUser } from '@/lib/api'
import FooterNav from '@/components/FooterNav'

// 根据银行卡号识别银行
function identifyBank(cardNumber: string): string {
  if (!cardNumber) return '未知银行'
  
  const card = cardNumber.replace(/\s/g, '')
  if (card.length < 6) return '未知银行'
  
  // 中国银行卡号识别规则（根据BIN号）
  // 按长度从长到短匹配，确保精确匹配优先
  const bankRules: { [key: string]: string } = {
    // 中国工商银行
    '622202': '工商银行', '622208': '工商银行', '955880': '工商银行', '621225': '工商银行',
    '621226': '工商银行', '621227': '工商银行', '621281': '工商银行', '621288': '工商银行',
    '621722': '工商银行', '621723': '工商银行', '625330': '工商银行', '625331': '工商银行',
    '625332': '工商银行', '625708': '工商银行', '625709': '工商银行',
    
    // 中国建设银行
    '622700': '建设银行', '622701': '建设银行', '622702': '建设银行', '622703': '建设银行',
    '622707': '建设银行', '622708': '建设银行', '436742': '建设银行', '436745': '建设银行',
    '453242': '建设银行', '524094': '建设银行', '526410': '建设银行', '552245': '建设银行',
    '621284': '建设银行', '621700': '建设银行', '621701': '建设银行', '621702': '建设银行',
    
    // 中国农业银行
    '622848': '农业银行', '622849': '农业银行', '622850': '农业银行', '622851': '农业银行',
    '622852': '农业银行', '103': '农业银行', '552599': '农业银行', '6349102': '农业银行',
    '6353591': '农业银行', '621336': '农业银行', '621337': '农业银行', '621338': '农业银行',
    '621339': '农业银行', '621671': '农业银行', '621672': '农业银行', '621673': '农业银行',
    
    // 中国银行
    '621660': '中国银行', '621661': '中国银行', '621662': '中国银行', '621663': '中国银行',
    '621667': '中国银行', '621668': '中国银行', '621669': '中国银行', '621666': '中国银行',
    '456418': '中国银行', '601382': '中国银行', '621756': '中国银行', '621757': '中国银行',
    '621758': '中国银行', '621759': '中国银行', '621785': '中国银行', '621786': '中国银行',
    
    // 交通银行
    '622258': '交通银行', '622259': '交通银行', '622260': '交通银行', '622261': '交通银行',
    '521899': '交通银行', '622253': '交通银行', '622254': '交通银行', '622255': '交通银行',
    '622256': '交通银行', '622257': '交通银行', '622150': '交通银行', '622151': '交通银行',
    '622152': '交通银行', '622153': '交通银行', '622154': '交通银行', '622155': '交通银行',
    
    // 招商银行
    '622575': '招商银行', '622576': '招商银行', '622577': '招商银行', '622578': '招商银行',
    '622579': '招商银行', '356885': '招商银行', '356886': '招商银行', '356887': '招商银行',
    '356888': '招商银行', '356890': '招商银行', '439188': '招商银行', '439225': '招商银行',
    '479228': '招商银行', '479229': '招商银行', '521302': '招商银行', '356889': '招商银行',
    '545620': '招商银行', '545621': '招商银行', '545947': '招商银行', '545948': '招商银行',
    '552534': '招商银行', '552587': '招商银行', '622575': '招商银行', '622576': '招商银行',
    '622577': '招商银行', '622578': '招商银行', '622579': '招商银行', '622580': '招商银行',
    '622581': '招商银行', '622582': '招商银行', '622588': '招商银行', '622598': '招商银行',
    '622622': '招商银行', '622623': '招商银行', '625802': '招商银行', '625803': '招商银行',
    
    // 浦发银行
    '622521': '浦发银行', '622522': '浦发银行', '622523': '浦发银行', '622524': '浦发银行',
    '622525': '浦发银行', '622526': '浦发银行', '622538': '浦发银行', '998801': '浦发银行',
    '998802': '浦发银行', '998803': '浦发银行', '622177': '浦发银行', '622277': '浦发银行',
    '622516': '浦发银行', '622518': '浦发银行', '515672': '浦发银行', '517650': '浦发银行',
    '525998': '浦发银行', '356851': '浦发银行', '356852': '浦发银行', '404738': '浦发银行',
    '404739': '浦发银行', '456418': '浦发银行', '498451': '浦发银行', '515672': '浦发银行',
    '517650': '浦发银行', '525998': '浦发银行', '356851': '浦发银行', '356852': '浦发银行',
    
    // 民生银行
    '622622': '民生银行', '622623': '民生银行', '622625': '民生银行', '622626': '民生银行',
    '622627': '民生银行', '622628': '民生银行', '622629': '民生银行', '622630': '民生银行',
    '622631': '民生银行', '622632': '民生银行', '622633': '民生银行', '356839': '民生银行',
    '356840': '民生银行', '356885': '民生银行', '356886': '民生银行', '356887': '民生银行',
    '356888': '民生银行', '356890': '民生银行', '356891': '民生银行', '356892': '民生银行',
    
    // 兴业银行
    '622909': '兴业银行', '622908': '兴业银行', '438588': '兴业银行', '438589': '兴业银行',
    '461982': '兴业银行', '486493': '兴业银行', '486494': '兴业银行', '486861': '兴业银行',
    '523036': '兴业银行', '451289': '兴业银行', '527414': '兴业银行', '528931': '兴业银行',
    '552599': '兴业银行', '356879': '兴业银行', '356880': '兴业银行', '356881': '兴业银行',
    '356882': '兴业银行', '622901': '兴业银行', '622902': '兴业银行', '622922': '兴业银行',
    
    // 中信银行
    '622690': '中信银行', '622691': '中信银行', '622692': '中信银行', '622696': '中信银行',
    '622698': '中信银行', '622998': '中信银行', '622999': '中信银行', '433670': '中信银行',
    '433680': '中信银行', '442729': '中信银行', '442730': '中信银行', '620082': '中信银行',
    '620083': '中信银行', '558916': '中信银行', '558917': '中信银行', '558918': '中信银行',
    '558919': '中信银行', '558920': '中信银行', '356839': '中信银行', '356840': '中信银行',
    '356878': '中信银行', '356879': '中信银行', '356880': '中信银行', '356881': '中信银行',
    '356882': '中信银行', '356883': '中信银行', '356884': '中信银行', '356885': '中信银行',
    
    // 光大银行
    '622650': '光大银行', '622655': '光大银行', '622650': '光大银行', '622658': '光大银行',
    '356839': '光大银行', '356840': '光大银行', '356881': '光大银行', '356882': '光大银行',
    '356883': '光大银行', '356884': '光大银行', '356885': '光大银行', '356886': '光大银行',
    '356887': '光大银行', '356888': '光大银行', '356889': '光大银行', '356890': '光大银行',
    
    // 华夏银行
    '622636': '华夏银行', '622637': '华夏银行', '622638': '华夏银行', '622639': '华夏银行',
    '622636': '华夏银行', '622637': '华夏银行', '622638': '华夏银行', '622639': '华夏银行',
    
    // 平安银行
    '622155': '平安银行', '622156': '平安银行', '622157': '平安银行', '622158': '平安银行',
    '622159': '平安银行', '356885': '平安银行', '356886': '平安银行', '356887': '平安银行',
    '356888': '平安银行', '356889': '平安银行', '356890': '平安银行', '356891': '平安银行',
    
    // 广发银行
    '622568': '广发银行', '622569': '广发银行', '622570': '广发银行', '622571': '广发银行',
    '622572': '广发银行', '622573': '广发银行', '622574': '广发银行', '520152': '广发银行',
    '520382': '广发银行', '541709': '广发银行', '541710': '广发银行', '548844': '广发银行',
    '552794': '广发银行', '558894': '广发银行', '625071': '广发银行', '625072': '广发银行',
    '625073': '广发银行', '625074': '广发银行', '625075': '广发银行', '625076': '广发银行',
    '625077': '广发银行', '625078': '广发银行', '625079': '广发银行', '625080': '广发银行',
    
    // 农村信用社/农商银行
    '622848': '农村信用社', '622849': '农村信用社', '622850': '农村信用社', '622851': '农村信用社',
    '622852': '农村信用社', '622853': '农村信用社', '622854': '农村信用社', '622855': '农村信用社',
    '621528': '农村信用社', '621529': '农村信用社', '621530': '农村信用社', '621531': '农村信用社',
    '621532': '农村信用社', '621533': '农村信用社', '621534': '农村信用社', '621535': '农村信用社',
    '621536': '农村信用社', '621537': '农村信用社', '621538': '农村信用社', '621539': '农村信用社',
    '621540': '农村信用社', '621541': '农村信用社', '621542': '农村信用社', '621543': '农村信用社',
    '621544': '农村信用社', '621545': '农村信用社', '621546': '农村信用社', '621547': '农村信用社',
    '621548': '农村信用社', '621549': '农村信用社', '621550': '农村信用社', '621551': '农村信用社',
    '621552': '农村信用社', '621553': '农村信用社', '621554': '农村信用社', '621555': '农村信用社',
    '621556': '农村信用社', '621557': '农村信用社', '621558': '农村信用社', '621559': '农村信用社',
    '621560': '农村信用社', '621561': '农村信用社', '621562': '农村信用社', '621563': '农村信用社',
    '621564': '农村信用社', '621565': '农村信用社', '621566': '农村信用社', '621567': '农村信用社',
    '621568': '农村信用社', '621569': '农村信用社', '621570': '农村信用社', '621571': '农村信用社',
    '621572': '农村信用社', '621573': '农村信用社', '621574': '农村信用社', '621575': '农村信用社',
    '621576': '农村信用社', '621577': '农村信用社', '621578': '农村信用社', '621579': '农村信用社',
    '621580': '农村信用社', '621581': '农村信用社', '621582': '农村信用社', '621583': '农村信用社',
    '621584': '农村信用社', '621585': '农村信用社', '621586': '农村信用社', '621587': '农村信用社',
    '621588': '农村信用社', '621589': '农村信用社', '621590': '农村信用社', '621591': '农村信用社',
    '621592': '农村信用社', '621593': '农村信用社', '621594': '农村信用社', '621595': '农村信用社',
    '621596': '农村信用社', '621597': '农村信用社', '621598': '农村信用社', '621599': '农村信用社',
  }
  
  // 按长度从长到短匹配，确保精确匹配优先
  // 先匹配6位
  const prefix6 = card.substring(0, 6)
  if (bankRules[prefix6]) {
    return bankRules[prefix6]
  }
  
  // 再匹配5位
  const prefix5 = card.substring(0, 5)
  if (bankRules[prefix5]) {
    return bankRules[prefix5]
  }
  
  // 再匹配4位
  const prefix4 = card.substring(0, 4)
  if (bankRules[prefix4]) {
    return bankRules[prefix4]
  }
  
  // 最后匹配3位
  const prefix3 = card.substring(0, 3)
  if (bankRules[prefix3]) {
    return bankRules[prefix3]
  }
  
  return '未知银行'
}

export default function UserInfoPage() {
  const router = useRouter()
  const [userInfo, setUserInfo] = useState<any>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (!checkLoginStatus(true)) {
      return
    }
    
    const loadUserData = async () => {
      try {
        const currentUser = getCurrentUser()
        if (!currentUser || !currentUser.phone) {
          router.push('/login')
          return
        }

        // 从数据库获取用户数据
        const response = await fetch(`/api/get_user_data?phone=${encodeURIComponent(currentUser.phone)}`)
        const result = await response.json()
        
        if (result.code === 200 && result.data) {
          setUserInfo(result.data)
        } else {
          // 如果获取失败，使用本地存储的数据
          setUserInfo(currentUser)
        }
      } catch (error) {
        console.error('加载用户数据失败:', error)
        // 如果获取失败，使用本地存储的数据
        const currentUser = getCurrentUser()
        setUserInfo(currentUser)
      } finally {
        setLoading(false)
      }
    }
    
    loadUserData()
  }, [router])

  if (loading) {
    return (
      <div style={{ padding: '20px', textAlign: 'center' }}>
        <div>加载中...</div>
      </div>
    )
  }

  const bankName = userInfo?.bank_card ? identifyBank(userInfo.bank_card) : '未知银行'
  const bankCardNumber = userInfo?.bank_card || ''

  return (
    <div className="userinfo-page-container">
      {/* Header */}
      <div className="userinfo-header">
        <button className="userinfo-back-btn" onClick={() => router.back()} type="button">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="#000000" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        </button>
        <h1 className="userinfo-title">我的资料</h1>
        <div style={{ width: '24px' }}></div>
      </div>

      {/* Personal Information Section */}
      <div className="userinfo-info-section">
        <div className="userinfo-info-item">
          <span className="userinfo-label">姓名</span>
          <span className="userinfo-value">{userInfo?.name || '-'}</span>
        </div>
        <div className="userinfo-info-item">
          <span className="userinfo-label">手机号</span>
          <span className="userinfo-value">{userInfo?.phone || '-'}</span>
        </div>
        <div className="userinfo-info-item">
          <span className="userinfo-label">身份证号</span>
          <span className="userinfo-value">{userInfo?.id_number || '-'}</span>
        </div>
        <div className="userinfo-info-item">
          <span className="userinfo-label">人脸识别</span>
          <span className="userinfo-value userinfo-status-approved">审核通过</span>
        </div>
      </div>

      {/* Bank Card Section */}
      <div className="userinfo-bank-card">
        <div className="bank-card-bank-name">{bankName}</div>
        <div className="bank-card-type">储蓄卡</div>
        <div className="bank-card-number">{bankCardNumber}</div>
      </div>

      <FooterNav />
    </div>
  )
}

